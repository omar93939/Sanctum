{% extends "layout.njk" %}

{% block head %}
  <title>Sanctum | Complete Registration</title>
  <meta name="description" content="Complete Registration">
  <style>
    #complete-registration {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin: 30px;
      font-size: 2em;
    }
    h2 {
      margin: 20px 0 0;
      font-size: 1.5em;
    }
    h3 {
      margin-top: 0;
      font-size: 1em;
      color: #ababb3;
    }
    #signup-username {
      width: 100%;
      max-width: 300px;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 1.2em;
      text-align: center;
      color: #1e1e1e;
    }
    #thumbnail {
      display: flex;
      background-color: #1e1e1e;
      margin-top: 10px;
      align-items: center;
      justify-content: center;
    }
    #thumbnail svg {
      position: absolute;
      font-size: 40px;
      z-index: 5;
      pointer-events: none;
      padding-bottom: 4px;
    }
    #thumbnail img {
      z-index: 1;
      top: -41px;
      object-fit: cover;
      border-radius: 0.4rem;
    }
    #thumbnail:hover {
      cursor: pointer;
    }
    #thumbnail:hover i {
      color: #7850a8;
    }
    #download-picture {
      margin: 10px;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      background-color: #7850a8;
      color: #1e1e1e;
      font-size: 1.2em;
      font-weight: bold;
    }
    #download-picture:hover {
      cursor: pointer;
      background-color: #614188;
    }
    #submit-registration {
      margin: 20px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: #7850a8;
      color: #1e1e1e;
      font-size: 1.2em;
      font-weight: bold;
    }
    #submit-registration:hover {
      cursor: pointer;
      background-color: #614188;
    }
    #submit-registration:disabled {
      background-color: #757576;
    }
    #error {
      font-size: 14px;
      color: #c73434;
    }
  </style>
  <script>
    let picture = false;
    function changePicture() {
      const thumbnail = document.getElementById('thumbnail').lastElementChild;
      const file = document.getElementById("thumbnail-input").files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          thumbnail.src = e.target.result;
          picture = file;
        }
        reader.readAsDataURL(file);
      }
    }
    function downloadPicture(url) {
      const thumbnail = document.getElementById('thumbnail').lastElementChild;
      fetch(url).then(response => response.blob()).then(blob => {
        picture = blob;
        thumbnail.src = URL.createObjectURL(blob);
      }).catch(err => {
        document.getElementById('error').innerText = 'Error downloading picture, please try again';
        picture = false;
      });
    }
    function submitRegistration(e) {
      e.preventDefault();
      const username = document.getElementById('signup-username').value;
      if (!username) {
        document.getElementById('error').innerText = 'Displayname is required';
        return;
      } else if (username.length < 1 || username.length > 40) {
        document.getElementById('error').innerText = 'Displayname must be between 6 and 40 characters';
        return;
      } else if (!username.match(/^[a-zA-Z0-9 ]+$/)) {
        document.getElementById('error').innerText = 'Displayname must only contain letters, numbers and spaces';
        return;
      }
      const submitButton = document.getElementById('submit-registration');
      submitButton.disabled = true;
      submitButton.innerText = 'Saving...';
      const data = {
        displayname: document.getElementById('signup-username').value
      }
      fetch('/register/oauth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      }).then((res) => {
        if (res.status === 200) {
          const next = document.getElementById('complete-registration').dataset.next;
          if (picture) {
            const img = new FormData();
            img.append('img', picture);
            fetch(`/register/oauth`, {
              method: 'PUT',
              body: img
            }).then((result) => {
              if (result.status === 200) {
                location.href = next || '/';
              } else {
                alert('Profile picture upload failed but registration was successful. To upload a profile picture, go to your profile settings');
                location.href = next || '/';
              }
            }).catch(err => {
              alert('Profile picture upload failed but registration was successful. To upload a profile picture, go to your profile settings');
              location.href = next || '/';
            });
          } else {
            location.href = next || '/';
          }
        } else {
          document.getElementById('error').innerText = 'Error completing registration, please try again';
          submitButton.disabled = false;
          submitButton.innerText = 'Submit';
        }
      }).catch(err => {
        document.getElementById('error').innerText = 'Error completing registration, please try again';
        submitButton.disabled = false;
        submitButton.innerText = 'Submit';
      });
    }
  </script>
{% endblock %}

{% block main %}

<form data-next="{{ next }}" id="complete-registration" autocomplete="off" onsubmit="event.preventDefault()">
  <h1>Complete Registration</h1>
  <h2>Choose a Displayname</h2>
  <h3>Displayname does NOT need to be unique.</h3>
  <input id="signup-username" class="signup-field" type="text" placeholder="Displayname (required)" autocomplete="off" value="{{ name }}">
  {% if picture %}
    <h2>Profile Picture (optional)</h2>
    <div id="thumbnail" onclick="this.firstElementChild.click()">
      <input id="thumbnail-input" type="file" name="thumbnail" accept="image/*" class="no-display" oninput="changePicture()">
      <svg id="upload-check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160L0 416c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 64z"/></svg>
      <img src="{{ cookies.pp or '/images/DefaultPP250p.jpg' }}" width="150px" height="150px" alt="Profile Picture">
    </div>
    <button type="button" data-picture="{{ picture }}" id="download-picture" onclick="downloadPicture(this.dataset.picture)">Download from {{ source }}</button>
  {% endif %}
  <button id="submit-registration" type="submit" onclick="submitRegistration(event)">Submit</button>
  <div id="error"></div>
</form>

{% endblock %}
